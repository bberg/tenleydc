{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div class="map-page">
    <div class="map-header">
        <h2>Interactive Map</h2>
        <p>Explore historic sites in Falls Church, Virginia</p>
    </div>

    <div class="map-container">
        <div id="map" class="interactive-map"></div>
    </div>

    <div class="map-legend">
        <h3>Historic Sites</h3>
        <div class="legend-items">
            <div class="legend-item" data-category="civil-rights">
                <span class="legend-marker civil-rights"></span>
                <span>Civil Rights Sites</span>
            </div>
            <div class="legend-item" data-category="landmark">
                <span class="legend-marker landmark"></span>
                <span>Landmarks</span>
            </div>
            <div class="legend-item" data-category="entertainment">
                <span class="legend-marker entertainment"></span>
                <span>Entertainment</span>
            </div>
            <div class="legend-item" data-category="church">
                <span class="legend-marker church"></span>
                <span>Religious Sites</span>
            </div>
        </div>
    </div>

    <div class="sites-list">
        <h3>Key Locations</h3>
        <div class="sites-grid">
            <div class="site-card" data-lat="38.8826" data-lng="-77.1711" onclick="panToLocation(38.8826, -77.1711, 'falls-church')">
                <h4><i class="fas fa-church"></i> The Falls Church</h4>
                <p>Historic 1769 church where George Washington was a vestryman</p>
                <span class="site-address">115 E Fairfax St</span>
            </div>
            <div class="site-card" data-lat="38.8847" data-lng="-77.1753" onclick="panToLocation(38.8847, -77.1753, 'state-theatre')">
                <h4><i class="fas fa-masks-theater"></i> State Theatre</h4>
                <p>1936 Art Deco movie palace, now a popular concert venue</p>
                <span class="site-address">220 N Washington St</span>
            </div>
            <div class="site-card" data-lat="38.8889" data-lng="-77.1847" onclick="panToLocation(38.8889, -77.1847, 'tinner-hill')">
                <h4><i class="fas fa-fist-raised"></i> Tinner Hill Historic Site</h4>
                <p>Site of first rural NAACP branch (1915)</p>
                <span class="site-address">Tinner Hill Rd & S Lee St</span>
            </div>
            <div class="site-card" data-lat="38.8833" data-lng="-77.1722" onclick="panToLocation(38.8833, -77.1722, 'cherry-hill')">
                <h4><i class="fas fa-tree"></i> Cherry Hill Park</h4>
                <p>Historic farmstead turned community park</p>
                <span class="site-address">312 Park Ave</span>
            </div>
            <div class="site-card" data-lat="38.8819" data-lng="-77.1714" onclick="panToLocation(38.8819, -77.1714, 'city-hall')">
                <h4><i class="fas fa-landmark"></i> City Hall</h4>
                <p>Government center for The Little City</p>
                <span class="site-address">300 Park Ave</span>
            </div>
            <div class="site-card" data-lat="38.8842" data-lng="-77.1731" onclick="panToLocation(38.8842, -77.1731, 'library')">
                <h4><i class="fas fa-book"></i> Mary Riley Styles Library</h4>
                <p>Public library serving the Falls Church community</p>
                <span class="site-address">120 N Virginia Ave</span>
            </div>
        </div>
    </div>

    <div class="map-info">
        <h3>About This Map</h3>
        <p>This interactive map shows key historic sites in Falls Church, Virginia. Click on markers or cards to learn more about each location.</p>
        <a href="/page/landmarks" class="btn">View All Landmarks</a>
    </div>
</div>

<style>
.interactive-map {
    width: 100%;
    height: 450px;
    border-radius: var(--radius-md);
    z-index: 1;
}

.site-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.site-card:hover {
    transform: translateY(-2px);
}

.site-card.active {
    border-color: var(--rust);
    box-shadow: 0 0 0 2px var(--rust-light);
}

/* Custom marker styles */
.custom-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: white;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.marker-civil-rights { background: #8b4513; }
.marker-landmark { background: #c45a3b; }
.marker-entertainment { background: #6b5b95; }
.marker-church { background: #2d6a4f; }

.leaflet-popup-content-wrapper {
    border-radius: 8px;
}

.leaflet-popup-content h4 {
    margin: 0 0 8px 0;
    color: var(--ink);
    font-size: 1rem;
}

.leaflet-popup-content p {
    margin: 0;
    color: var(--ink-light);
    font-size: 0.875rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Falls Church
    const map = L.map('map').setView([38.8840, -77.1720], 15);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Historic sites data
    const sites = [
        {
            id: 'falls-church',
            name: 'The Falls Church',
            lat: 38.8826,
            lng: -77.1711,
            category: 'church',
            icon: 'fa-church',
            description: 'Historic Episcopal church established 1733, current building from 1769. George Washington and George Mason served as vestrymen.',
            link: '/page/history'
        },
        {
            id: 'state-theatre',
            name: 'State Theatre',
            lat: 38.8847,
            lng: -77.1753,
            category: 'entertainment',
            icon: 'fa-masks-theater',
            description: 'Art Deco movie palace opened in 1936, now one of the area\'s premier live music venues.',
            link: '/page/state_theater'
        },
        {
            id: 'tinner-hill',
            name: 'Tinner Hill Historic Site',
            lat: 38.8889,
            lng: -77.1847,
            category: 'civil-rights',
            icon: 'fa-fist-raised',
            description: 'Site where Joseph Tinner and E.B. Henderson organized the first rural NAACP branch in 1915 to fight segregation.',
            link: '/page/tinner_hill'
        },
        {
            id: 'cherry-hill',
            name: 'Cherry Hill Park',
            lat: 38.8833,
            lng: -77.1722,
            category: 'landmark',
            icon: 'fa-tree',
            description: 'Historic farmstead property now serving as a community park and event venue.'
        },
        {
            id: 'city-hall',
            name: 'City Hall',
            lat: 38.8819,
            lng: -77.1714,
            category: 'landmark',
            icon: 'fa-landmark',
            description: 'Government center for the independent City of Falls Church, one of the smallest cities in the US.'
        },
        {
            id: 'library',
            name: 'Mary Riley Styles Library',
            lat: 38.8842,
            lng: -77.1731,
            category: 'landmark',
            icon: 'fa-book',
            description: 'Public library serving the Falls Church community with local history collections.'
        }
    ];

    // Store markers for reference
    window.markers = {};

    // Add markers for each site
    sites.forEach(site => {
        const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="custom-marker marker-${site.category}"><i class="fas ${site.icon}"></i></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        const marker = L.marker([site.lat, site.lng], { icon: icon }).addTo(map);

        let popupContent = `<h4>${site.name}</h4><p>${site.description}</p>`;
        if (site.link) {
            popupContent += `<p><a href="${site.link}" style="color: #c45a3b;">Learn more &rarr;</a></p>`;
        }

        marker.bindPopup(popupContent);
        window.markers[site.id] = marker;
    });

    // Store map reference globally
    window.historyMap = map;
});

// Pan to location and open popup
function panToLocation(lat, lng, markerId) {
    if (window.historyMap && window.markers[markerId]) {
        window.historyMap.setView([lat, lng], 17, { animate: true });
        window.markers[markerId].openPopup();

        // Highlight active card
        document.querySelectorAll('.site-card').forEach(card => card.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
}
</script>
{% endblock %}
